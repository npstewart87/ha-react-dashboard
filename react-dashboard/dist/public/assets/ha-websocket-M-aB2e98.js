function S(t){return{type:"auth",access_token:t}}function R(){return{type:"supported_features",id:1,features:{coalesce_messages:1}}}function y(){return{type:"get_states"}}function T(t,e,n,r,s){const i={type:"call_service",domain:t,service:e,target:r,return_response:s};return n&&(i.service_data=n),i}function O(t){const e={type:"subscribe_events"};return t&&(e.event_type=t),e}function g(t){return{type:"unsubscribe_events",subscription:t}}function I(){return{type:"ping"}}function N(t,e){return{type:"result",success:!1,error:{code:t,message:e}}}function C(t){const e={},n=t.split("&");for(let r=0;r<n.length;r++){const s=n[r].split("="),i=decodeURIComponent(s[0]),o=s.length>1?decodeURIComponent(s[1]):void 0;e[i]=o}return e}const v=(t,e,n,r)=>{const[s,i,o]=t.split(".",3);return Number(s)>e||Number(s)===e&&(r===void 0?Number(i)>=n:Number(i)>n)||r!==void 0&&Number(s)===e&&Number(i)===n&&Number(o)>=r},L="auth_invalid",A="auth_ok";function M(t){if(!t.auth)throw 4;const e=t.auth;let n=e.expired?e.refreshAccessToken().then(()=>{n=void 0},()=>{n=void 0}):void 0;const r=e.wsUrl;function s(i,o,c){const a=new WebSocket(r);let u=!1;const d=()=>{if(a.removeEventListener("close",d),u){c(2);return}if(i===0){c(1);return}const _=i===-1?-1:i-1;setTimeout(()=>s(_,o,c),1e3)},b=async _=>{try{e.expired&&await(n||e.refreshAccessToken()),a.send(JSON.stringify(S(e.accessToken)))}catch(l){u=l===2,a.close()}},f=async _=>{const l=JSON.parse(_.data);switch(l.type){case L:u=!0,a.close();break;case A:a.removeEventListener("open",b),a.removeEventListener("message",f),a.removeEventListener("close",d),a.removeEventListener("error",d),a.haVersion=l.ha_version,v(a.haVersion,2022,9)&&a.send(JSON.stringify(R())),o(a);break}};a.addEventListener("open",b),a.addEventListener("message",f),a.addEventListener("close",d),a.addEventListener("error",d)}return new Promise((i,o)=>s(t.setupRetry,i,o))}class U{constructor(e,n){this._handleMessage=r=>{let s=JSON.parse(r.data);Array.isArray(s)||(s=[s]),s.forEach(i=>{const o=this.commands.get(i.id);switch(i.type){case"event":o?o.callback(i.event):(console.warn(`Received event for unknown subscription ${i.id}. Unsubscribing.`),this.sendMessagePromise(g(i.id)).catch(c=>{}));break;case"result":o&&(i.success?(o.resolve(i.result),"subscribe"in o||this.commands.delete(i.id)):(o.reject(i.error),this.commands.delete(i.id)));break;case"pong":o?(o.resolve(),this.commands.delete(i.id)):console.warn(`Received unknown pong response ${i.id}`);break}})},this._handleClose=async()=>{const r=this.commands;if(this.commandId=1,this.oldSubscriptions=this.commands,this.commands=new Map,this.socket=void 0,r.forEach(o=>{"subscribe"in o||o.reject(N(3,"Connection lost"))}),this.closeRequested)return;this.fireEvent("disconnected");const s=Object.assign(Object.assign({},this.options),{setupRetry:0}),i=o=>{setTimeout(async()=>{if(!this.closeRequested)try{const c=await s.createSocket(s);this._setSocket(c)}catch(c){if(this._queuedMessages){const a=this._queuedMessages;this._queuedMessages=void 0;for(const u of a)u.reject&&u.reject(3)}c===2?this.fireEvent("reconnect-error",c):i(o+1)}},Math.min(o,5)*1e3)};this.suspendReconnectPromise&&(await this.suspendReconnectPromise,this.suspendReconnectPromise=void 0,this._queuedMessages=[]),i(0)},this.options=n,this.commandId=2,this.commands=new Map,this.eventListeners=new Map,this.closeRequested=!1,this._setSocket(e)}get connected(){return this.socket!==void 0&&this.socket.readyState==this.socket.OPEN}_setSocket(e){this.socket=e,this.haVersion=e.haVersion,e.addEventListener("message",this._handleMessage),e.addEventListener("close",this._handleClose);const n=this.oldSubscriptions;n&&(this.oldSubscriptions=void 0,n.forEach(s=>{"subscribe"in s&&s.subscribe&&s.subscribe().then(i=>{s.unsubscribe=i,s.resolve()})}));const r=this._queuedMessages;if(r){this._queuedMessages=void 0;for(const s of r)s.resolve()}this.fireEvent("ready")}addEventListener(e,n){let r=this.eventListeners.get(e);r||(r=[],this.eventListeners.set(e,r)),r.push(n)}removeEventListener(e,n){const r=this.eventListeners.get(e);if(!r)return;const s=r.indexOf(n);s!==-1&&r.splice(s,1)}fireEvent(e,n){(this.eventListeners.get(e)||[]).forEach(r=>r(this,n))}suspendReconnectUntil(e){this.suspendReconnectPromise=e}suspend(){if(!this.suspendReconnectPromise)throw new Error("Suspend promise not set");this.socket&&this.socket.close()}reconnect(e=!1){if(this.socket){if(!e){this.socket.close();return}this.socket.removeEventListener("message",this._handleMessage),this.socket.removeEventListener("close",this._handleClose),this.socket.close(),this._handleClose()}}close(){this.closeRequested=!0,this.socket&&this.socket.close()}async subscribeEvents(e,n){return this.subscribeMessage(e,O(n))}ping(){return this.sendMessagePromise(I())}sendMessage(e,n){if(!this.connected)throw 3;if(this._queuedMessages){if(n)throw new Error("Cannot queue with commandId");this._queuedMessages.push({resolve:()=>this.sendMessage(e)});return}n||(n=this._genCmdId()),e.id=n,this.socket.send(JSON.stringify(e))}sendMessagePromise(e){return new Promise((n,r)=>{if(this._queuedMessages){this._queuedMessages.push({reject:r,resolve:async()=>{try{n(await this.sendMessagePromise(e))}catch(i){r(i)}}});return}const s=this._genCmdId();this.commands.set(s,{resolve:n,reject:r}),this.sendMessage(e,s)})}async subscribeMessage(e,n,r){if(this._queuedMessages&&await new Promise((i,o)=>{this._queuedMessages.push({resolve:i,reject:o})}),r!=null&&r.preCheck&&!await r.preCheck())throw new Error("Pre-check failed");let s;return await new Promise((i,o)=>{const c=this._genCmdId();s={resolve:i,reject:o,callback:e,subscribe:(r==null?void 0:r.resubscribe)!==!1?()=>this.subscribeMessage(e,n,r):void 0,unsubscribe:async()=>{this.connected&&await this.sendMessagePromise(g(c)),this.commands.delete(c)}},this.commands.set(c,s);try{this.sendMessage(n,c)}catch{}}),()=>s.unsubscribe()}_genCmdId(){return++this.commandId}}const P=()=>`${location.protocol}//${location.host}/`,D=t=>t*1e3+Date.now();function q(){const{protocol:t,host:e,pathname:n,search:r}=location;return`${t}//${e}${n}${r}`}function H(t,e,n,r){let s=`${t}/auth/authorize?response_type=code&redirect_uri=${encodeURIComponent(n)}`;return e!==null&&(s+=`&client_id=${encodeURIComponent(e)}`),r&&(s+=`&state=${encodeURIComponent(r)}`),s}function x(t,e,n,r){n+=(n.includes("?")?"&":"?")+"auth_callback=1",document.location.href=H(t,e,n,r)}async function E(t,e,n){const r=typeof location<"u"&&location;if(r&&r.protocol==="https:"){const c=document.createElement("a");if(c.href=t,c.protocol==="http:"&&c.hostname!=="localhost")throw 5}const s=new FormData;e!==null&&s.append("client_id",e),Object.keys(n).forEach(c=>{s.append(c,n[c])});const i=await fetch(`${t}/auth/token`,{method:"POST",credentials:"same-origin",body:s});if(!i.ok)throw i.status===400||i.status===403?2:new Error("Unable to fetch tokens");const o=await i.json();return o.hassUrl=t,o.clientId=e,o.expires=D(o.expires_in),o}function m(t,e,n){return E(t,e,{code:n,grant_type:"authorization_code"})}function $(t){return btoa(JSON.stringify(t))}function V(t){return JSON.parse(atob(t))}class k{constructor(e,n){this.data=e,this._saveTokens=n}get wsUrl(){return`ws${this.data.hassUrl.substr(4)}/api/websocket`}get accessToken(){return this.data.access_token}get expired(){return Date.now()>this.data.expires}async refreshAccessToken(){if(!this.data.refresh_token)throw new Error("No refresh_token");const e=await E(this.data.hassUrl,this.data.clientId,{grant_type:"refresh_token",refresh_token:this.data.refresh_token});e.refresh_token=this.data.refresh_token,this.data=e,this._saveTokens&&this._saveTokens(e)}async revoke(){if(!this.data.refresh_token)throw new Error("No refresh_token to revoke");const e=new FormData;e.append("token",this.data.refresh_token),await fetch(`${this.data.hassUrl}/auth/revoke`,{method:"POST",credentials:"same-origin",body:e}),this._saveTokens&&this._saveTokens(null)}}function W(t,e){return new k({hassUrl:t,clientId:null,expires:Date.now()+1e11,refresh_token:"",access_token:e,expires_in:1e11})}async function X(t={}){let e,n=t.hassUrl;n&&n[n.length-1]==="/"&&(n=n.substr(0,n.length-1));const r=t.clientId!==void 0?t.clientId:P(),s=t.limitHassInstance===!0;if(t.authCode&&n&&(e=await m(n,r,t.authCode),t.saveTokens&&t.saveTokens(e)),!e){const i=C(location.search.substr(1));if("auth_callback"in i){const o=V(i.state);if(s&&(o.hassUrl!==n||o.clientId!==r))throw 6;e=await m(o.hassUrl,o.clientId,i.code),t.saveTokens&&t.saveTokens(e)}}if(!e&&t.loadTokens&&(e=await t.loadTokens()),e&&(n===void 0||e.hassUrl===n))return new k(e,t.saveTokens);if(n===void 0)throw 4;return x(n,r,t.redirectUrl||q(),$({hassUrl:n,clientId:r})),new Promise(()=>{})}const j=t=>{let e=[];function n(s){let i=[];for(let o=0;o<e.length;o++)e[o]===s?s=null:i.push(e[o]);e=i}function r(s,i){t=i?s:Object.assign(Object.assign({},t),s);let o=e;for(let c=0;c<o.length;c++)o[c](t)}return{get state(){return t},action(s){function i(o){r(o,!1)}return function(){let o=[t];for(let a=0;a<arguments.length;a++)o.push(arguments[a]);let c=s.apply(this,o);if(c!=null)return c instanceof Promise?c.then(i):i(c)}},setState:r,clearState(){t=void 0},subscribe(s){return e.push(s),()=>{n(s)}}}},J=5e3,p=(t,e,n,r,s={unsubGrace:!0})=>{if(t[e])return t[e];let i=0,o,c,a=j();const u=()=>{if(!n)throw new Error("Collection does not support refresh");return n(t).then(h=>a.setState(h,!0))},d=()=>u().catch(h=>{if(t.connected)throw h}),b=()=>{if(c!==void 0){clearTimeout(c),c=void 0;return}r&&(o=r(t,a)),n&&(t.addEventListener("ready",d),d()),t.addEventListener("disconnected",l)},f=()=>{c=void 0,o&&o.then(h=>{h()}),a.clearState(),t.removeEventListener("ready",u),t.removeEventListener("disconnected",l)},_=()=>{c=setTimeout(f,J)},l=()=>{c&&(clearTimeout(c),f())};return t[e]={get state(){return a.state},refresh:u,subscribe(h){i++,i===1&&b();const w=a.subscribe(h);return a.state!==void 0&&setTimeout(()=>h(a.state),0),()=>{w(),i--,i||(s.unsubGrace?_():f())}}},t[e]},G=t=>t.sendMessagePromise(y()),Z=(t,e,n,r,s,i)=>t.sendMessagePromise(T(e,n,r,s,i));function z(t,e){const n=Object.assign({},t.state);if(e.a)for(const r in e.a){const s=e.a[r];let i=new Date(s.lc*1e3).toISOString();n[r]={entity_id:r,state:s.s,attributes:s.a,context:typeof s.c=="string"?{id:s.c,parent_id:null,user_id:null}:s.c,last_changed:i,last_updated:s.lu?new Date(s.lu*1e3).toISOString():i}}if(e.r)for(const r of e.r)delete n[r];if(e.c)for(const r in e.c){let s=n[r];if(!s){console.warn("Received state update for unknown entity",r);continue}s=Object.assign({},s);const{"+":i,"-":o}=e.c[r],c=(i==null?void 0:i.a)||(o==null?void 0:o.a),a=c?Object.assign({},s.attributes):s.attributes;if(i&&(i.s!==void 0&&(s.state=i.s),i.c&&(typeof i.c=="string"?s.context=Object.assign(Object.assign({},s.context),{id:i.c}):s.context=Object.assign(Object.assign({},s.context),i.c)),i.lc?s.last_updated=s.last_changed=new Date(i.lc*1e3).toISOString():i.lu&&(s.last_updated=new Date(i.lu*1e3).toISOString()),i.a&&Object.assign(a,i.a)),o!=null&&o.a)for(const u of o.a)delete a[u];c&&(s.attributes=a),n[r]=s}t.setState(n,!0)}const F=(t,e)=>t.subscribeMessage(n=>z(e,n),{type:"subscribe_entities"});function Q(t,e){const n=t.state;if(n===void 0)return;const{entity_id:r,new_state:s}=e.data;if(s)t.setState({[s.entity_id]:s});else{const i=Object.assign({},n);delete i[r],t.setState(i,!0)}}async function B(t){const e=await G(t),n={};for(let r=0;r<e.length;r++){const s=e[r];n[s.entity_id]=s}return n}const K=(t,e)=>t.subscribeEvents(n=>Q(e,n),"state_changed"),Y=t=>v(t.haVersion,2022,4,0)?p(t,"_ent",void 0,F):p(t,"_ent",B,K),ee=(t,e)=>Y(t).subscribe(e);async function te(t){const e=Object.assign({setupRetry:0,createSocket:M},t),n=await e.createSocket(e);return new U(n,e)}export{W as a,Z as b,te as c,X as g,ee as s};
